<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ãƒŸã‚¯ãƒ©ã‚¤ãƒ–é‘‘è³å±¥æ­´ãƒ„ãƒ¼ãƒ«</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body {
  font-family: system-ui, sans-serif;
  background:#fafafa;
  margin:0;
  padding:20px;
}
h1,h2,h3 { margin-top:1.2em; }
section { margin-bottom:30px; }

.event {
  background:#fff;
  border:1px solid #ccc;
  border-radius:8px;
  padding:10px;
  margin-bottom:8px;
}

button {
  padding:6px 12px;
  margin-top:10px;
}

.result {
  background:#eef;
  border-radius:8px;
  padding:15px;
}

.miku { color:#39c5bb; }
.rinlen { color:#f5b400; }
.luka { color:#ff8fd1; }
.meiko { color:#e53935; }
.kaito { color:#1e88e5; }

footer {
  font-size:12px;
  color:#555;
  border-top:1px solid #ccc;
  padding-top:15px;
}
</style>
</head>
<body>

<h1>ğŸ¤ ãƒŸã‚¯ãƒ©ã‚¤ãƒ–é‘‘è³å±¥æ­´ãƒ„ãƒ¼ãƒ«</h1>

<p>
éå»ã®åˆéŸ³ãƒŸã‚¯é–¢é€£ãƒ©ã‚¤ãƒ–ã‹ã‚‰ã€<br>
<strong>ã‚ãªãŸãŒå®Ÿéš›ã«è¦‹ãŸæ¼”ç›®</strong>ã‚’æŒ¯ã‚Šè¿”ã‚‹ãŸã‚ã®éå…¬å¼ãƒ»éå•†ç”¨ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚
</p>

<!-- ================= ç®¡ç†è€…ã‚¨ãƒªã‚¢ ================= -->

<section>
<h2>ğŸ›  ç®¡ç†è€…ç”¨ï¼šã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆè‡ªå‹•å–å¾—</h2>

<input id="eventName" placeholder="ä¾‹ï¼šãƒã‚¸ã‚«ãƒ«ãƒŸãƒ©ã‚¤2013">
<input id="eventYear" placeholder="å¹´ï¼ˆä¾‹ï¼š2013ï¼‰">
<button onclick="fetchSetlist()">åˆéŸ³ãƒŸã‚¯Wikiã‹ã‚‰å–å¾—</button>

<div id="adminArea"></div>
</section>

<!-- ================= ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠ ================= -->

<section>
<h2>â‘  è¦‹ãŸå…¬æ¼”ã‚’é¸æŠ</h2>
<div id="eventList"></div>
<button onclick="showResult()">çµæœã‚’è¦‹ã‚‹</button>
</section>

<!-- ================= ãƒªã‚¶ãƒ«ãƒˆ ================= -->

<section>
<div id="result" class="result" style="display:none;"></div>
</section>

<footer>
<p>
æœ¬ã‚µã‚¤ãƒˆã¯ã€åˆéŸ³ãƒŸã‚¯é–¢é€£ãƒ©ã‚¤ãƒ–ã‚’é‘‘è³ã—ãŸå€‹äººãŒã€è‡ªèº«ã®é‘‘è³å±¥æ­´ã‚’æŒ¯ã‚Šè¿”ã‚‹ç›®çš„ã§åˆ¶ä½œã—ãŸ
éå…¬å¼ãƒ»éå•†ç”¨ã®ãƒ•ã‚¡ãƒ³ã‚µã‚¤ãƒˆã§ã™ã€‚<br><br>

æœ¬ã‚µã‚¤ãƒˆã¯ã€ã‚¯ãƒªãƒ—ãƒˆãƒ³ãƒ»ãƒ•ãƒ¥ãƒ¼ãƒãƒ£ãƒ¼ãƒ»ãƒ¡ãƒ‡ã‚£ã‚¢æ ªå¼ä¼šç¤¾ãŠã‚ˆã³é–¢ä¿‚å„ç¤¾ãƒ»å…¬å¼ã‚¤ãƒ™ãƒ³ãƒˆã¨ã¯ä¸€åˆ‡é–¢ä¿‚ã‚ã‚Šã¾ã›ã‚“ã€‚<br><br>

æ²è¼‰å†…å®¹ã«å•é¡ŒãŒã‚ã‚‹å ´åˆã€æ¨©åˆ©è€…æ§˜ã‹ã‚‰ã®ã”é€£çµ¡ã«ã‚ˆã‚Šé€Ÿã‚„ã‹ã«ä¿®æ­£ãƒ»å‰Šé™¤å¯¾å¿œã‚’è¡Œã„ã¾ã™ã€‚
</p>

<p>
Â© Crypton Future Media, INC. www.piapro.net<br>
â€» ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŠã‚ˆã³æ¥½æ›²ã®æ¨©åˆ©ã¯å„æ¨©åˆ©è€…ã«å¸°å±ã—ã¾ã™ã€‚
</p>
</footer>

<script>
let events = [];

// ã‚­ãƒ£ãƒ©åˆ¤å®šï¼ˆã–ã£ãã‚Šï¼‰
function getCharClass(song) {
  if (song.match(/ãƒªãƒ³|ãƒ¬ãƒ³|Rin|Len/i)) return "rinlen";
  if (song.match(/ãƒ«ã‚«|Luka/i)) return "luka";
  if (song.match(/MEIKO/i)) return "meiko";
  if (song.match(/KAITO/i)) return "kaito";
  return "miku";
}

// åˆéŸ³ãƒŸã‚¯Wikiã‹ã‚‰å–å¾—
async function fetchSetlist() {
  const name = document.getElementById("eventName").value;
  const year = document.getElementById("eventYear").value;
  const admin = document.getElementById("adminArea");
  admin.innerHTML = "å–å¾—ä¸­â€¦";

  const url =
    "https://w.atwiki.jp/hmiku/api.php" +
    "?action=parse" +
    "&page=" + encodeURIComponent(name) +
    "&prop=wikitext" +
    "&format=json" +
    "&origin=*";

  try {
    const res = await fetch(url);
    const data = await res.json();
    if (!data.parse) {
      admin.innerHTML = "ãƒšãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚";
      return;
    }

    const text = data.parse.wikitext["*"];
    const songs = text.split("\n")
      .filter(l => l.startsWith("*") || l.match(/^[0-9]+/))
      .map(l =>
        l.replace(/[*0-9\.ï¼\[\]]/g,"")
         .replace(/ï¼ˆ.*?ï¼‰/g,"")
         .trim()
      )
      .filter(l => l.length > 1);

    const unique = [...new Set(songs)];

    admin.innerHTML =
      "<h3>å–å¾—çµæœï¼ˆç¢ºèªå¾Œã«åæ˜ ï¼‰</h3>" +
      unique.map(s => "ãƒ»" + s).join("<br>") +
      "<br><button onclick='approveEvent(\""+name+"\",\""+year+"\","+JSON.stringify(unique)+")'>æ‰¿èªã—ã¦åæ˜ </button>";

  } catch {
    admin.innerHTML = "å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
  }
}

// æ‰¿èª â†’ ä¸Šæ›¸ã
function approveEvent(name, year, songs) {
  events = events.filter(e => !(e.name === name && e.year === year));
  events.push({ name, year, songs });
  renderEvents();
  document.getElementById("adminArea").innerHTML = "åæ˜ ã—ã¾ã—ãŸã€‚";
}

// å…¬æ¼”è¡¨ç¤º
function renderEvents() {
  const list = document.getElementById("eventList");
  list.innerHTML = "";
  events.forEach((e,i) => {
    const div = document.createElement("div");
    div.className = "event";
    div.innerHTML =
      `<label>
        <input type="checkbox" data-index="${i}">
        ${e.name}ï¼ˆ${e.year}ï¼‰
      </label>`;
    list.appendChild(div);
  });
}

// çµæœè¡¨ç¤º
function showResult() {
  const checked = document.querySelectorAll("input[type=checkbox]:checked");
  const seen = {};

  checked.forEach(c => {
    const ev = events[c.dataset.index];
    ev.songs.forEach(s => {
      const key = s.toLowerCase();
      if (!seen[key]) seen[key] = s;
    });
  });

  const res = document.getElementById("result");
  res.style.display = "block";

  if (Object.keys(seen).length === 0) {
    res.innerHTML = "ã¾ã é¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚";
    return;
  }

  res.innerHTML =
    "<h2>â‘¡ ãƒªã‚¶ãƒ«ãƒˆ</h2>" +
    Object.values(seen)
      .map(s => `<div class="${getCharClass(s)}">${s}</div>`)
      .join("");
}
</script>

</body>
</html>
